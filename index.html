<!DOCTYPE html>
<html lang="fa">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>تحلیل رنگ تصویر</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/color-thief/2.3.0/color-thief.min.js"></script>
  <style>
    body {
      font-family: Tahoma, sans-serif;
      direction: rtl;
      background: #f8f9fa;
      padding: 20px;
      color: #333;
    }
    h3 {
      text-align: center;
      margin-bottom: 20px;
      color: #0d3a94;
      text-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }
    input[type="file"], input[type="number"] {
      padding: 6px 10px;
      border-radius: 8px;
      border: 1px solid #ccc;
      outline: none;
      font-size: 1rem;
      margin-left: 10px;
      vertical-align: middle;
    }
    label {
      font-weight: bold;
      vertical-align: middle;
    }
    /* استایل دکمه‌ها */
    button {
      padding: 12px 20px;
      border-radius: 10px;
      border: none;
      background: linear-gradient(145deg, #4a90e2, #357abd);
      color: white;
      font-weight: 700;
      font-size: 1rem;
      cursor: pointer;
      box-shadow:
        inset 0 -3px 6px rgba(255,255,255,0.3),
        0 6px 12px rgba(70, 130, 180, 0.5);
      transition: all 0.3s ease;
      user-select: none;
      outline: none;
      margin-left: 8px;
      min-width: 120px;
    }
    button:hover {
      background: linear-gradient(145deg, #357abd, #2a5c9e);
      box-shadow:
        inset 0 3px 6px rgba(255,255,255,0.5),
        0 8px 18px rgba(70, 130, 180, 0.7);
      transform: translateY(-2px);
    }
    button:active {
      background: linear-gradient(145deg, #2a5c9e, #1d3f6e);
      box-shadow:
        inset 0 3px 8px rgba(0,0,0,0.4);
      transform: translateY(1px);
    }

    /* دکمه‌های تب */
    .tab-buttons {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
      justify-content: center;
    }
    .tab-buttons button {
      background: linear-gradient(145deg, #e3e6f3, #cfd4e7);
      color: #444;
      font-weight: 600;
      box-shadow:
        inset 0 3px 6px rgba(255,255,255,0.8),
        0 2px 4px rgba(0,0,0,0.1);
      margin-left: 0;
      min-width: 100px;
      padding: 10px 16px;
      transition: background 0.25s ease, color 0.25s ease, box-shadow 0.25s ease;
    }
    .tab-buttons button:hover {
      background: linear-gradient(145deg, #bec7f2, #a7afff);
      color: #0d3a94;
      box-shadow:
        inset 0 3px 6px rgba(255,255,255,0.9),
        0 4px 8px rgba(20, 40, 130, 0.3);
      transform: translateY(-1px);
    }
    .tab-buttons button.active {
      background: linear-gradient(145deg, #0d6efd, #054abe);
      color: white;
      box-shadow:
        0 6px 14px rgba(13, 110, 253, 0.75),
        inset 0 -2px 8px rgba(255,255,255,0.3);
      font-weight: 700;
      transform: translateY(-2px);
    }

    .tabs {
      margin-top: 20px;
      max-width: 900px;
      margin-left: auto;
      margin-right: auto;
    }
    .tab-content {
      display: none;
      margin-top: 15px;
      background: #ffffff;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      min-height: 150px;
    }
    .tab-content.active {
      display: block;
    }
    #colorPalette .color-wrapper {
      display: inline-block;
      width: 90px;
      text-align: center;
      margin: 10px;
      user-select: none;
    }
    .color-box {
      width: 90px;
      height: 60px;
      border-radius: 6px;
      border: 1px solid #ccc;
      margin-bottom: 5px;
      cursor: pointer;
      box-shadow: 0 0 6px rgba(0,0,0,0.1);
      transition: transform 0.3s ease;
    }
    .color-box:hover {
      transform: scale(1.1);
      box-shadow: 0 0 12px rgba(0,0,0,0.3);
    }
    #colorModelsList li {
      margin-bottom: 12px;
      background: #f0f4ff;
      padding: 12px;
      border-radius: 10px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.1);
      font-family: monospace;
      font-size: 0.95rem;
      color: #222;
    }
    #preview {
      max-width: 100%;
      max-height: 300px;
      margin-top: 20px;
      border: 1px solid #ccc;
      border-radius: 10px;
      display: block;
      margin-left: auto;
      margin-right: auto;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }
    /* ریسپانسیو */
    @media (max-width: 600px) {
      button {
        min-width: 100px;
        font-size: 0.9rem;
        padding: 10px 14px;
      }
      #colorPalette .color-wrapper {
        width: 70px;
      }
      .color-box {
        width: 70px;
        height: 50px;
      }
    }
  </style>
</head>
<body>
  <h3>تحلیل رنگ تصویر</h3>

  <div style="text-align:center; margin-bottom: 15px;">
    <input type="file" id="imageInput" accept="image/*" />
    <label for="colorCount">تعداد رنگ‌های غالب:</label>
    <input type="number" id="colorCount" value="5" min="1" max="20" style="width:60px;" />
    <button onclick="extractColors()">استخراج رنگ</button>
    <button onclick="savePaletteAsJSON()">ذخیره پالت به JSON</button>
  </div>

  <img id="preview" style="display:none;" crossorigin="anonymous" alt="تصویر انتخاب شده" />

  <div id="tabs" class="tabs" style="display:none;">
    <div class="tab-buttons">
      <button class="active" onclick="showTab('palette', this)">پالت رنگی</button>
      <button onclick="showTab('models', this)">مدل‌های رنگی</button>
    </div>

    <div id="palette" class="tab-content active">
      <h4>رنگ‌های استخراج‌شده:</h4>
      <div id="colorPalette"></div>
    </div>

    <div id="models" class="tab-content">
      <h4>مدل‌های رنگی:</h4>
      <ul id="colorModelsList"></ul>
    </div>
  </div>

  <script>
    const preview = document.getElementById("preview");
    const imageInput = document.getElementById("imageInput");
    const colorPalette = document.getElementById("colorPalette");
    const colorModelsList = document.getElementById("colorModelsList");

    let paletteCounter = 1;
    let allPalettes = {};

    function rgbToHex(r, g, b) {
      return "#" + [r, g, b].map(x => x.toString(16).padStart(2, '0')).join('').toUpperCase();
    }

    function rgbToHsl(r, g, b) {
      r /= 255; g /= 255; b /= 255;
      let max = Math.max(r, g, b), min = Math.min(r, g, b);
      let h, s, l = (max + min) / 2;
      if (max !== min) {
        let d = max - min;
        s = l > 0.5 ? d / (2 - max - min) : d / (max + min);
        switch (max) {
          case r: h = (g - b) / d + (g < b ? 6 : 0); break;
          case g: h = (b - r) / d + 2; break;
          case b: h = (r - g) / d + 4; break;
        }
        h /= 6;
      } else h = s = 0;
      return `HSL(${Math.round(h*360)}, ${Math.round(s*100)}%, ${Math.round(l*100)}%)`;
    }

    function rgbToHsv(r, g, b) {
      r /= 255; g /= 255; b /= 255;
      let max = Math.max(r, g, b), min = Math.min(r, g, b);
      let h, s, v = max;
      let d = max - min;
      s = max === 0 ? 0 : d / max;
      if (max === min) {
        h = 0;
      } else {
        switch (max) {
          case r: h = (g - b) / d + (g < b ? 6 : 0); break;
          case g: h = (b - r) / d + 2; break;
          case b: h = (r - g) / d + 4; break;
        }
        h /= 6;
      }
      return `HSV(${Math.round(h*360)}, ${Math.round(s*100)}%, ${Math.round(v*100)}%)`;
    }

    function rgbToCmyk(r, g, b) {
      let c = 1 - (r / 255), m = 1 - (g / 255), y = 1 - (b / 255);
      let k = Math.min(c, m, y);
      if (k === 1) return "CMYK(0%, 0%, 0%, 100%)";
      c = ((c - k) / (1 - k)) * 100;
      m = ((m - k) / (1 - k)) * 100;
      y = ((y - k) / (1 - k)) * 100;
      k = k * 100;
      return `CMYK(${Math.round(c)}%, ${Math.round(m)}%, ${Math.round(y)}%, ${Math.round(k)}%)`;
    }

    function extractColors() {
      const file = imageInput.files[0];
      if (!file) return alert("تصویری انتخاب نشده است.");

      const reader = new FileReader();
      reader.onload = () => {
        preview.src = reader.result;
        preview.style.display = 'block';
        preview.onload = () => {
          const count = parseInt(document.getElementById("colorCount").value) || 5;
          const colorThief = new ColorThief();
          let palette;
          try {
            palette = colorThief.getPalette(preview, count);
          } catch (e) {
            alert("خطا در استخراج رنگ‌ها. مطمئن شوید تصویر به درستی بارگذاری شده است.");
            return;
          }

          document.getElementById("tabs").style.display = "block";
          colorPalette.innerHTML = "";
          colorModelsList.innerHTML = "";

          let paletteData = [];

          palette.forEach((color, index) => {
            const hex = rgbToHex(...color);
            const rgb = `RGB(${color[0]}, ${color[1]}, ${color[2]})`;
            const hsl = rgbToHsl(...color);
            const hsv = rgbToHsv(...color);
            const cmyk = rgbToCmyk(...color);

            const wrapper = document.createElement("div");
            wrapper.className = "color-wrapper";

            const box = document.createElement("div");
            box.className = "color-box";
            box.style.backgroundColor = hex;

            const label = document.createElement("div");
            label.innerText = `رنگ ${index + 1}`;

            wrapper.appendChild(box);
            wrapper.appendChild(label);
            colorPalette.appendChild(wrapper);

            const li = document.createElement("li");
            li.innerHTML = `<strong>رنگ ${index + 1}</strong><br>HEX: ${hex}<br>${rgb}<br>${hsl}<br>${hsv}<br>${cmyk}`;
            colorModelsList.appendChild(li);

            paletteData.push({
              index: index + 1,
              hex, rgb, hsl, hsv, cmyk
            });
          });

          allPalettes[`پالت ${paletteCounter}`] = paletteData;
          paletteCounter++;
        };
      };
      reader.readAsDataURL(file);
    }

    function savePaletteAsJSON() {
      if (Object.keys(allPalettes).length === 0) {
        alert("هیچ پالتی استخراج نشده است!");
        return;
      }
      const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(allPalettes, null, 2));
      const dlAnchor = document.createElement('a');
      dlAnchor.setAttribute("href", dataStr);
      dlAnchor.setAttribute("download", "palettes.json");
      dlAnchor.click();
    }

    function showTab(tabId, btn) {
      document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
      document.querySelectorAll('.tab-buttons button').forEach(b => b.classList.remove('active'));
      document.getElementById(tabId).classList.add('active');
      btn.classList.add('active');
    }
  </script>
</body>
</html>
