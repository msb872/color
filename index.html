<!DOCTYPE html>
<html lang="fa">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ابزار رنگ‌ها</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/color-thief/2.3.0/color-thief.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <style>
    body { direction: rtl; }
    .color-box { width: 50px; height: 50px; display: inline-block; margin: 2px; border: 1px solid #ccc; cursor: pointer; }
  </style>
</head>
<body>
  <div class="container mt-3">
    <ul class="nav nav-tabs">
      <li class="nav-item"><a class="nav-link active" data-bs-toggle="tab" href="#color-picker">شبیه‌ساز رنگ‌ها</a></li>
      <!-- باقی تب‌ها مشابه قبلی... -->
    </ul>
    <div class="tab-content mt-3">
      <div class="tab-pane fade show active" id="color-picker">
        <h3>شبیه‌ساز رنگ‌ها</h3>
        <input type="color" id="colorPicker">
        <button class="btn btn-primary mt-2" id="downloadColor">دانلود تصویر</button>
        <canvas id="colorCanvas" width="300" height="270" class="d-none mt-3"></canvas>
      </div>
      <!-- سایر تب‌ها مشابه... -->
    </div>
  </div>

  <script>
    // —————— کمک‌توابع عمومی ——————
    function hexToRgb(hex) {
      let m = hex.match(/^#?([0-9a-f]{6})$/i);
      if (!m) return null;
      let v = parseInt(m[1], 16);
      return [(v >> 16) & 255, (v >> 8) & 255, v & 255];
    }
    function rgbToCmyk([r, g, b]){
      let rn=r/255, gn=g/255, bn=b/255;
      let k=1-Math.max(rn, gn, bn);
      return k===1 ? [0,0,0,1] : [(1-rn-k)/(1-k), (1-gn-k)/(1-k), (1-bn-k)/(1-k), k];
    }
    function setCanvasDisplay(c, show){
      c.classList.toggle('d-none', !show);
    }

    // —————— شبیه‌ساز رنگ ——————
    const colorCanvas = document.getElementById('colorCanvas');
    document.getElementById('colorPicker').addEventListener('input', e=>{
      let hex = e.target.value;
      let rgb = hexToRgb(hex);
      if (!rgb) return;
      let [c, m, y, k] = rgbToCmyk(rgb).map(n => (n*100).toFixed(1)+'%');
      let ctx = colorCanvas.getContext('2d');
      setCanvasDisplay(colorCanvas, true);
      ctx.clearRect(0, 0, colorCanvas.width, colorCanvas.height);
      ctx.fillStyle = hex; ctx.fillRect(0,0, colorCanvas.width, colorCanvas.height-70);
      ctx.fillStyle='#000'; ctx.fillRect(0, colorCanvas.height-70, colorCanvas.width, 70);
      ctx.fillStyle='#fff'; ctx.font='16px Vazir';
      let cx=colorCanvas.width/2;
      ctx.textAlign='center';
      ['HEX: '+hex, `RGB: ${rgb.join(',')}`, `CMYK: ${c},${m},${y},${k}`]
        .forEach((txt,i)=>ctx.fillText(txt, cx, colorCanvas.height-50+20*i));
    });
    document.getElementById('downloadColor').addEventListener('click', ()=>{
      if (colorCanvas.classList.contains('d-none')) return;
      let a=document.createElement('a');
      a.href=colorCanvas.toDataURL();
      a.download='color.png'; a.click();
    });

    // —————— استخراج رنگ از تصویر ——————
    // مشابه نسخه قبلی با toDataURL و کلیک روی تصویر برای استخراج پیکسل

    // —————— تحلیل رنگ با ColorThief ——————
    // مانند نسخه قبلی ولی بدون ایجاد المان‌های Style فراوان

    // —————— مقایسه رنگ‌ها ——————
    function distanceRGB(a,b){
      return Math.hypot(a[0]-b[0],a[1]-b[1],a[2]-b[2]).toFixed(2);
    }
    window.compareColors = ()=>{
      let a = hexToRgb(document.getElementById('compareColor1').value);
      let b = hexToRgb(document.getElementById('compareColor2').value);
      document.getElementById('compareResult').innerText = `فاصله: ${distanceRGB(a,b)}`;
    };

    // —————— تولید رنگ تصادفی ——————
    window.generateRandomColor = ()=>{
      let hex = '#'+Math.floor(Math.random()*0xFFFFFF).toString(16).padStart(6, '0');
      document.getElementById('randomColorDisplay').innerText = hex;
      document.getElementById('randomColorPreview').style.background = hex;
    };

    // —————— ترکیب رنگ ——————
    function blend(a,b,p=0.5){
      const out = a.map((v,i)=>Math.round(v*p + b[i]*(1-p)));
      return '#'+out.map(v=>v.toString(16).padStart(2,'0')).join('').toUpperCase();
    }
    const blendRatio = document.getElementById('blendRatio');
    const blendRatioDisplay = document.getElementById('blendRatioDisplay');
    blendRatio.addEventListener('input', ()=> blendRatioDisplay.innerText = blendRatio.value + '%');
    window.blendColors = ()=>{
      let a=hexToRgb(document.getElementById('blendColor1').value),
          b=hexToRgb(document.getElementById('blendColor2').value),
          p=blendRatio.value/100;
      let h = blend(a,b,p);
      document.getElementById('blendColorResult').innerText=h;
      document.getElementById('blendColorPreview').style.background=h;
    };

    // —————— تبدیل نام رنگ و سایر تب‌ها ——————
    const colorNames = { "#FF0000":"قرمز", "#00FF00":"سبز", /* ... */ };
    window.convertColorToName = ()=> {
      let n=colorNames[document.getElementById('nameColorPicker').value.toUpperCase()];
      document.getElementById('colorNameDisplay').innerText = n || 'نامشخص';
    };

    window.showColorModels = ()=>{
      let rgb = hexToRgb(document.getElementById('modelColorPicker').value);
      let cmyk = rgbToCmyk(rgb).map(n=> (n*100).toFixed(1)+'%');
      let [r,g,b] = rgb;
      let rN=r/255, gN=g/255, bN=b/255;
      let max=Math.max(rN,gN,bN), min=Math.min(rN,gN,bN);
      let l=(max+min)/2;
      let d=max-min;
      let s = d? l>0.5? d/(2-max-min):d/(max+min) : 0;
      let h = d ? (
        max===rN? (gN-bN)/d + (gN<bN?6:0):
        max===gN? (bN-rN)/d+2:
        (rN-gN)/d+4
      ) *60 : 0;
      let hsv = [Math.round(h),Math.round(s*100),Math.round(max*100)];
      document.getElementById('colorModelsDisplay').innerHTML =
        ['HEX','#RGB','CMYK','HSL','HSV']
          .map((t,i)=>`<p>${t}: ${i===1?rgb.join(','):i===2?cmyk.join(','):i===3?`${Math.round(h)}°,${Math.round(s*100)}%,${Math.round(l*100)}%`:i===4?`${hsv.join('°,')}%`:document.getElementById('modelColorPicker').value}</p>`)
          .join('');
    };

    // —————— پالت رنگ ——————
    let paletteArray=[];
    window.addToPalette = ()=>{
      let c = document.getElementById('paletteColorPicker').value;
      paletteArray.push(c);
      updatePaletteDisplay();
    };
    window.clearPalette = ()=>{paletteArray=[];updatePaletteDisplay()};
    function updatePaletteDisplay(){
      let con = document.getElementById('paletteDisplay');
      con.innerHTML = '';
      paletteArray.forEach((c,i)=>{
        let div = document.createElement('div');
        div.className='color-box'; div.style.background = c; div.title=c;
        div.onclick= ()=> {paletteArray.splice(i,1); updatePaletteDisplay()};
        con.append(div);
      });
    }

    // —————— شبیه‌سازی نابینایی ——————
    window.simulateColorBlindness = ()=>{
      let [r,g] = hexToRgb(document.getElementById('blindColorPicker').value);
      let rB=Math.round(0.56667*r+0.43333*g), gB=Math.round(0.55833*r+0.44167*g);
      let bB=Math.round(0.24167*g+0.75833*parseInt(document.getElementById('blindColorPicker').value.substring(5,7),16));
      let hex=['rB','gB','bB'].map((k)=>eval(k).toString(16).padStart(2,'0')).join('').toUpperCase();
      document.getElementById('blindColorDisplay').innerText='#'+hex;
      document.getElementById('blindColorPreview').style.background='#'+hex;
    };

    // —————— ویرایش تصویر and شبیه‌سازی توافق رنگ ——————
    // مانند نسخه قبلی ولی توابع جدا-شده و استفاده از helper به جای تکرار

  </script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
